<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Contract</title>
    <script src="https://code.jquery.com/jquery-3.6.4.js" integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</head>
<body>
<th:block th:include="/_menu"></th:block>
<div class = "row" style="height: 81%">
    <div class="col-2">
        <ul class="list-group vh-79 left-nav-scroll">
            <li class="list-group-item">An item</li>
            <li class="list-group-item">A second item</li>
            <li class="list-group-item">A third item</li>
            <li class="list-group-item">A fourth item</li>
            <li class="list-group-item">And a fifth one</li>
            <li class="list-group-item">An item</li>
            <li class="list-group-item">A second item</li>
            <li class="list-group-item">A third item</li>
            <li class="list-group-item">A fourth item</li>
            <li class="list-group-item">And a fifth one</li>
            <li class="list-group-item">An item</li>
            <li class="list-group-item">A second item</li>
            <li class="list-group-item">A third item</li>
            <li class="list-group-item">A fourth item</li>
            <li class="list-group-item">And a fifth one</li>
            <li class="list-group-item">An item</li>
            <li class="list-group-item">A second item</li>
            <li class="list-group-item">A third item</li>
            <li class="list-group-item">A fourth item</li>
            <li class="list-group-item">And a fifth one</li>
            <li class="list-group-item">An item</li>
            <li class="list-group-item">A second item</li>
            <li class="list-group-item">A third item</li>
            <li class="list-group-item">A fourth item</li>
            <li class="list-group-item">And a fifth one</li>
            <li class="list-group-item">An item</li>
            <li class="list-group-item">A second item</li>
            <li class="list-group-item">A third item</li>
            <li class="list-group-item">A fourth item</li>
            <li class="list-group-item">And a fifth one</li>
            <li class="list-group-item">An item</li>
            <li class="list-group-item">A second item</li>
            <li class="list-group-item">A third item</li>
            <li class="list-group-item">A fourth item</li>
            <li class="list-group-item">And a fifth one</li>
        </ul>
    </div>
    <div class="col-10"> <h1>List Contract</h1>
        <p id="mainMsg"></p>
        <!-- Button trigger modal -->
        <div class="d-flex justify-content-end" style="width: 95%;padding-bottom: 10px">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal">
                Register new contract
            </button>
        </div>
        <table class="table table-info" style="width: 98%;">
            <tr style="text-align: center">
                <th>#</th>
                <th>Facility</th>
                <th>Customer</th>
                <th>Start date</th>
                <th>End date</th>
                <th>Deposit</th>
                <th>Payment</th>
                <th colspan="2">Facility</th>
            </tr>
                <tr th:each="contract, row:${pages}">
                    <td th:text="${contract.getId()}"></td>
                    <td th:text="${contract.getFacility()}"></td>
                    <td th:text="${contract.getCustomer()}"></td>
                    <td th:text="${contract.getStartDate()}"></td>
                    <td th:text="${contract.getEndDate()}"></td>
                    <td th:text="${#numbers.formatDecimal(contract.getDeposit(),1,'COMMA',0,'POINT')}" class="text-end"></td>
                    <td th:text="${#numbers.formatDecimal(contract.getPayment(),1,'COMMA',0,'POINT')}" class="text-end"></td>
                    <td>
                        <!-- Button trigger modal -->


                        <a th:href="@{/getNewContractDetail(id=${contract.getId()},page=${currentPage}) }" >
                            <button type="submit" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addModal">
                                +
                            </button>
                        </a>
                    </td>
                    <td>
                        <!-- Button trigger modal -->
<!--                        <form th:action="@{/getContractDetail}" method="post">-->
<!--                            <input th:value="${currentPage}" id="currentPage" type="hidden">-->
<!--                            <input th:value="${contract.getId()}" type="hidden" name="facilityId" id="facilityId">-->
<!--                            <button type="submit" id="submit" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#showlist">-->
<!--                                Attach facility list-->
<!--                            </button>-->
<!--                        </form>-->
                        <a th:href="@{/getContractDetail(id=${contract.getId()},page=${currentPage}) }" >
                            <button type="submit" id="submit" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#showlist">
                                Attach facility list
                            </button>
                        </a>
                    </td>
                </tr>
        </table>
        <div class="text-center">
            <a th:href="@{/contract(page =${pages.number - 1})}" th:if="${pages.hasPrevious()}"><button class="btn btn-primary">Previous</button></a>
            <span th:text="${pages.number+1}"></span>/<span th:text="${pages.totalPages}"></span>
            <a th:href="@{/contract(page =${pages.number + 1})}" th:if="${pages.hasNext()}"><button class="btn btn-primary">Next</button></a>
        </div>
    </div>
</div>
<input type="hidden" th:value="${flag}"  id="flag">
<input type="hidden" th:value="${flagAdd}"  id="flagAdd">
<div class="modal fade" id="addServiceModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Add new facility</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <p id="messsage" name="messsage"></p>
            <form>
                <div class="p-4">
                    <div class="mb-3">
                        <label class="form-label">Start date</label>
                        <input type="date" class="form-control" id="startdate" name="startdate" onchange="caculPayment()">
<!--                        <small style="color: red" th:if="${#fields.hasErrors('startdate')}" th:errors="*{startdate}"></small><br>-->
                    </div>
                    <div class="mb-3">
                        <label class="form-label">End date</label>
                        <input type="date" class="form-control" id="enddate" name="enddate" onchange="caculPayment()">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Deposit</label>
                        <input type="number" class="form-control" id="deposit" name="deposit" onchange="caculPayment()">
<!--                        <small style="color: red" th:if="${#fields.hasErrors('deposit')}" th:errors="*{deposit}"></small><br>-->
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment</label>
                        <input type="number" class="form-control" id="caculResult" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Employee</label><br>
                        <select name="employeeId" id="employeeId" style="height: 38px; width: 450px">
                                <option class="form-select" th:each="employee : ${pulldownEmployeeName}" th:text="${employee.getName()}" th:value="${employee.getId()}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer</label><br>
                        <select name="customerId" id="customerId" style="height: 38px; width: 450px">
                            <option class="form-select" th:each="customer : ${pulldownCustomerName}" th:text="${customer.getName()}" th:value="${customer.getId()}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Facility</label><br>
                        <select name="serviceId" style="height: 38px; width: 450px" id="serviceId" onchange="caculPayment()">
                            <option  class="form-select service_cus" th:each="facility : ${pulldownFacilityName}" th:text="${facility.getName()}" th:value="${facility.getId()}" th:data="${facility.getCost()}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Attach facility</label><br>
                        <select name="addNewService" style="height: 38px" id="addNewService">
                            <option  class="form-select service_cus" th:each="attrach : ${pulldownAttachFacilityName}" th:text="${attrach.getName()}" th:value="${attrach.getName()}" th:data="${attrach.getCost()}" th:subId="${attrach.getId()}"></option>
                        </select>
                        <button type="button" class="btn btn-info" onclick="addService()">+</button>
                        <p id="shownew" name="shownew"></p>
                        ----- show table
                        <p id="table" name="table"></p>

                        <input type="hidden" id="subServices" name="subServices">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="registerNewContract">Register</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!--&lt;!&ndash; Modal list &ndash;&gt;-->
<div class="modal fade" id="showlist" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" >
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel2">Attach facility list</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <table class="table table-striped">
                <tr style="text-align: center">
                    <th>Facility name</th>
                    <th>Price</th>
                    <th>Unit</th>
                    <th>Quanlity</th>
                </tr>
                <div  th:if="${#lists.isEmpty(listContractDetail)}">
                    <tr>
                        <td colspan="4" class="text-center">No record</td>
                    </tr>
                </div>
                <div th:if="${not #lists.isEmpty(listContractDetail)}" th:each="contractDetail, row:${listContractDetail}">
                    <tr>
                        <td th:text="${contractDetail.getName()}"></td>
                        <td th:text="${contractDetail.getCost()}"></td>
                        <td th:text="${contractDetail.getUnit()}"></td>
                        <td th:text="${contractDetail.getQuantity()}"></td>
                    </tr>
                </div>
            </table>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" >
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel3">Add new attach facility</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <table class="table table-striped">
                <tr>
                    <td>
                        <label class="form-label">Attach Facility</label></td>
                    <td>
                    <div class="mb-3">
                        <input type="hidden" th:value="${newId}">
                        <select name="attachFacilityId" id="attactFacilityId" style="height: 38px; width: 450px">
                            <option class="form-select" th:each="attachFacility : ${pulldownAttachFacilityName}" th:text="${attachFacility.getName()}" th:value="${attachFacility.getId()}"></option>
                        </select>
                    </div>
                    </td>
                </tr>
                <tr>
                    <td>Number</td>
                    <td>
                        <input type="number" id="numberOfAttachFacility">
                    </td>
                </tr>
            </table>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-secondary" data-bs-dismiss="modal">Add</button>
            </div>
            </form>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        document.getElementById("registerNewContract").disabled  = true;
        let flag = $("#flag").val();
        let flagAdd = $("#flagAdd").val();
        if(flag == 1){
            $("#showlist").modal("show");
        }
        if(flagAdd == 1){
            $("#addModal").modal("show");
        }
        $("#registerNewContract").click(function () {
            registerNewContract();
        });
        function registerNewContract() {
            let startdate = $("#startdate").val();
            let enddate = $("#enddate").val();
            let deposit = $("#deposit").val();
            let employeeId = $("#employeeId").val();
            let customerId = $("#customerId").val();
            let facilityId = $("#serviceId").val();
            let contract ={
                startdate:startdate,
                enddate:enddate,
                deposit:deposit,
                employee:{
                    id:employeeId
                },
                customer:{
                    id:customerId
                },
                facility:{
                    id:facilityId
                }
            }
            $.ajax({
                contentType: 'application/json;',
                dataType: 'json',
                type: 'POST',
                url: 'http://localhost:8080/api/registerNewContract',
                data: JSON.stringify(contract),
                success: function () {
                },
                complete: function () {
                    document.getElementById("mainMsg").innerText  = "Register success!";
                }
            });
        }
    })

    let listSubService = [];
    let listServicePrice = [];
    let lisSubServiceId = [];
    function addService() {
        let newService = document.getElementById("addNewService").value;
        lisSubServiceId.push(GetSubServiceId(newService));
        listServicePrice.push(GetSubServicePrice(newService));
        listSubService.push(newService);

        /*show table*/
        let stringTable = ""
        stringTable += '    <table class=\'table tab-content\'>\n' +
            '        <tr>\n' +
            '            <th>SubService</th>\n' +
            '            <th>Unit</th>\n' +
            '            <th>Price</th>\n' +
            '            <th>Count</th>\n' +
            '        </tr>\n';

        stringTable +=
            '        <tr>\n' +
            '            <td>'+listSubService[0]+'</td>\n' +
            '            <td>Unit</td>\n' +
            '            <td>'+listServicePrice[0]+'</td>\n' +
            '            <td id="count_0" name="count_0">1</td>\n' +
            '        </tr>\n';
        if(listSubService.length>0){
            for (let i = 1; i < listSubService.length; i++) {
                stringTable += '<tr>';
                console.log("listSubService[i]" +listSubService[i] + ", i=" + i)
                console.log("listSubService[i-1]" +listSubService[i-1])
                if(listSubService[i] != listSubService[i-1]){
                    stringTable += '<td>'+listSubService[i]+'</td>';
                    stringTable += '<td></td>';
                    stringTable += '<td>'+listServicePrice[i]+'</td>';
                    stringTable += '<td id="count_'+lisSubServiceId[i]+'" name="count_'+lisSubServiceId[i]+'">1</td>\n';
                }else {
                    let count_id = "count_" + (i-1);
                    console.log(count_id);
                    let count = parseInt(document.getElementById(count_id).innerText)+1;
                    console.log(count);
                    document.getElementById(count_id).innerHTML = ""+count;
                    console.log(count);
                }
            }
        }
        stringTable += '</tr>';
        stringTable +='</table>';
        document.getElementById("table").innerHTML = stringTable;
        /*show table*/


        document.getElementById("shownew").innerText = listSubService;
        document.getElementById("subServices").value = lisSubServiceId;
        caculPayment();
    }
    function caculPayment() {
        let serviceId = document.getElementById("serviceId").value;
        let deposit = document.getElementById("deposit").value;
        let sum = 0;
        for(let price of listServicePrice){
            sum += parseInt(price);
        }
        if(GetDays()>0){
            document.getElementById("caculResult").value = GetDays()*GetServicePrice(serviceId) - deposit + sum;
            checkTrueValue();
        }
    }
    function GetSubServiceId(id) {
        let subId;
        const els = document.getElementsByClassName("addNewService");
        for (let el of els) {
            if (el.value == id) {
                subId = el.getAttribute('subId');
                return subId;
            }
        }
    }
    function GetSubServicePrice(id) {
        let priceData;
        const els = document.getElementsByClassName("addNewService");
        for (let el of els) {
            if (el.value == id) {
                priceData = el.getAttribute('data');
                return priceData;
            }
        }
    }
    function GetServicePrice(serviceId) {
        let priceData;
        const els = document.getElementsByClassName("service_cus");
        for (let el of els) {
            if (el.value == serviceId) {
                priceData = el.getAttribute('data');
                return priceData;
            }
        }
    }
    function GetDays(){
        var startdate = new Date(document.getElementById("startdate").value);
        var enddate = new Date(document.getElementById("enddate").value);
        var datediff = parseInt((enddate - startdate) / (24 * 3600 * 1000));
        document.getElementById("messsage").innerText  = "";
        if(datediff<0){
            document.getElementById("messsage").innerText  = "Let pick another date !";
            document.getElementById("caculResult").value = "";
            document.getElementById("registerNewContract").disabled  = true;
            return;
        }else if(datediff==0){
            document.getElementById("messsage").innerText  = "";
            return 1;
        }
        document.getElementById("registerNewContract").disabled  = false;
        return datediff;
    }
    function checkTrueValue(){
        let caculResult = document.getElementById("caculResult").value;
        if(caculResult<0){
            document.getElementById("messsage").innerText = "Deposit value is false!";
            document.getElementById("registerNewContract").disabled  = true;
        }else {
            document.getElementById("registerNewContract").disabled  = false;
        }
    }
</script>
</body>
</html>